name: Migrate Test Environment

on: workflow_dispatch

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Run migrations on server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: server.strom.sk
          username: webstrom
          key: ${{ secrets.WEBSTROM_DEPLOY_SSH_PRIVATE_KEY }}
          script: |
            set -e

            CONTAINER_NAME="webstrom-test_webstrom-backend"

            # Check if container exists and is running
            if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "❌ Container $CONTAINER_NAME is not running!"
              exit 1
            fi

            # Run migrations
            echo "Running migrations in $CONTAINER_NAME..."
            docker exec "$CONTAINER_NAME" python manage.py migrate --noinput

            echo "✅ Migrations completed successfully!"
